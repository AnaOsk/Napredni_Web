extends layout

block content
    .container.mx-auto.px-4.py-8.max-w-6xl
        h1.text-3xl.font-bold.text-gray-800.mb-2= title
        p.text-gray-600.mb-8 Arhivirani projekti na kojima ste bili voditelj ili clan tima

        if !currentUser
            .bg-white.rounded-lg.shadow-md.p-8.text-center
                h2.text-2xl.font-semibold.text-gray-700.mb-4 Dobrodosli!
                p.text-gray-600.mb-6 Prijavite se za pristup arhivi.
                .flex.justify-center.gap-4
                    a.bg-indigo-600.text-white.px-6.py-3.rounded-md.font-medium(href='/auth/login', class='hover:bg-indigo-700') Prijava

        if currentUser
            .grid.grid-cols-1.gap-6(class='lg:grid-cols-2')

                //- LIJEVA KOLONA - Detalji projekta
                .space-y-6
                    #projectInfo.bg-white.rounded-lg.shadow-md.p-6
                        h2.text-xl.font-semibold.text-gray-700.mb-4.border-b.pb-2 Detalji projekta
                        input#currentProjectId(type='hidden')
                        .space-y-3
                            .flex
                                span.font-medium.text-gray-600.w-40 Naziv:
                                span#projectInfoNaziv.text-gray-800 -
                            .flex
                                span.font-medium.text-gray-600.w-40 Opis:
                                span#projectInfoOpis.text-gray-800 -
                            .flex
                                span.font-medium.text-gray-600.w-40 Cijena:
                                span
                                    span#projectInfoCijena.text-gray-800 -
                                    |  EUR
                            .flex
                                span.font-medium.text-gray-600.w-40 Obavljeni poslovi:
                                span#projectInfoPoslovi.text-gray-800 -
                            .flex
                                span.font-medium.text-gray-600.w-40 Voditelj:
                                span#projectInfoVoditelj.text-gray-800 -
                            .flex
                                span.font-medium.text-gray-600.w-40 Datum pocetka:
                                span#projectInfoPocetak.text-gray-800 -
                            .flex
                                span.font-medium.text-gray-600.w-40 Datum zavrsetka:
                                span#projectInfoZavrsetak.text-gray-800 -
                            .flex
                                span.font-medium.text-gray-600.w-40 Moja uloga:
                                span#projectInfoMojaUloga.text-gray-800 -

                        //- CLANOVI TIMA (samo pregled)
                        #teamSection.mt-6.pt-6.border-t(style='display:none;')
                            h3.text-lg.font-semibold.text-gray-700.mb-4 Clanovi tima
                            .overflow-x-auto
                                table#teamList.w-full.text-sm
                                    thead.bg-gray-50
                                        tr
                                            th.px-4.py-2.text-left.font-medium.text-gray-600 Ime
                                            th.px-4.py-2.text-left.font-medium.text-gray-600 Uloga
                                            th.px-4.py-2.text-left.font-medium.text-gray-600 Email
                                    tbody.divide-y.divide-gray-200

                //- DESNA KOLONA - Lista arhiviranih projekata
                .space-y-6
                    #projectList.bg-white.rounded-lg.shadow-md.p-6
                        h2.text-xl.font-semibold.text-gray-700.mb-4.border-b.pb-2 Arhivirani projekti
                        .overflow-x-auto
                            table.w-full.text-sm
                                thead.bg-gray-50
                                    tr
                                        th.px-4.py-3.text-left.font-medium.text-gray-600 Naziv
                                        th.px-4.py-3.text-left.font-medium.text-gray-600 Voditelj
                                        th.px-4.py-3.text-left.font-medium.text-gray-600 Moja uloga
                                        th.px-4.py-3.text-left.font-medium.text-gray-600 Zavrsetak
                                tbody.divide-y.divide-gray-200

    script.
        window.projectListEndpoint = '/projects/arhiva-list';
        window.isArchivePage = true;

        $(document).ready(function() {
            loadArchiveProjects();
        });

        function loadArchiveProjects() {
            $.getJSON('/projects/arhiva-list', function(data) {
                var tableContent = '';
                var currentUserId = null;

                // Dohvati trenutni userId iz sessiona
                $.ajax({
                    url: '/projects/users',
                    async: false,
                    success: function(users) {
                        // Pronadi sebe u listi korisnika - koristimo username iz navigacije
                        var currentUsername = $('nav span.text-gray-700').text().replace('| ', '').trim();
                        users.forEach(function(u) {
                            if (u.username === currentUsername) {
                                currentUserId = u._id;
                            }
                        });
                    }
                });

                $.each(data, function(index, project) {
                    var voditelj = project.voditelj ? project.voditelj.username : '-';
                    var zavrsetak = project.datumZavrsetka ? new Date(project.datumZavrsetka).toLocaleDateString('hr-HR') : '-';

                    // Odredi moju ulogu na projektu
                    var mojaUloga = '-';
                    if (project.voditelj && project.voditelj._id === currentUserId) {
                        mojaUloga = 'Voditelj projekta';
                    }
                    if (project.clanoviTima) {
                        project.clanoviTima.forEach(function(clan) {
                            if (clan.korisnik && clan.korisnik._id === currentUserId) {
                                mojaUloga = clan.uloga || '-';
                            }
                        });
                    }

                    tableContent += '<tr class="hover:bg-gray-50 cursor-pointer project-row" data-id="' + project._id + '">';
                    tableContent += '<td class="px-4 py-3 text-blue-600 hover:underline">' + (project.naziv || '-') + '</td>';
                    tableContent += '<td class="px-4 py-3">' + voditelj + '</td>';
                    tableContent += '<td class="px-4 py-3">' + mojaUloga + '</td>';
                    tableContent += '<td class="px-4 py-3">' + zavrsetak + '</td>';
                    tableContent += '</tr>';
                });

                if (data.length === 0) {
                    tableContent = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Nema arhiviranih projekata.</td></tr>';
                }

                $('#projectList table tbody').html(tableContent);

                // Spremi podatke za later
                window.archiveData = data;
                window.currentUserId = currentUserId;
            });
        }

        // Klik na projekt za prikaz detalja
        $(document).on('click', '.project-row', function() {
            var projectId = $(this).data('id');
            showArchiveProjectInfo(projectId);
        });

        function showArchiveProjectInfo(projectId) {
            var project = window.archiveData.find(function(p) { return p._id === projectId; });
            if (project) {
                $('#currentProjectId').val(project._id);
                $('#projectInfoNaziv').text(project.naziv || '-');
                $('#projectInfoOpis').text(project.opis || '-');
                $('#projectInfoCijena').text(project.cijena || '-');
                $('#projectInfoPoslovi').text(project.obavljeniPoslovi || '-');
                $('#projectInfoVoditelj').text(project.voditelj ? project.voditelj.username : '-');
                $('#projectInfoPocetak').text(project.datumPocetka ? new Date(project.datumPocetka).toLocaleDateString('hr-HR') : '-');
                $('#projectInfoZavrsetak').text(project.datumZavrsetka ? new Date(project.datumZavrsetka).toLocaleDateString('hr-HR') : '-');

                // Odredi moju ulogu
                var mojaUloga = '-';
                if (project.voditelj && project.voditelj._id === window.currentUserId) {
                    mojaUloga = 'Voditelj projekta';
                }
                if (project.clanoviTima) {
                    project.clanoviTima.forEach(function(clan) {
                        if (clan.korisnik && clan.korisnik._id === window.currentUserId) {
                            mojaUloga = clan.uloga || '-';
                        }
                    });
                }
                $('#projectInfoMojaUloga').text(mojaUloga);

                // Prikazi clanove tima
                var teamContent = '';
                if (project.clanoviTima && project.clanoviTima.length > 0) {
                    $.each(project.clanoviTima, function(index, clan) {
                        var ime = clan.korisnik ? clan.korisnik.username : '-';
                        var email = clan.korisnik ? clan.korisnik.email : '-';
                        teamContent += '<tr>';
                        teamContent += '<td class="px-4 py-2">' + ime + '</td>';
                        teamContent += '<td class="px-4 py-2">' + (clan.uloga || '-') + '</td>';
                        teamContent += '<td class="px-4 py-2">' + email + '</td>';
                        teamContent += '</tr>';
                    });
                } else {
                    teamContent = '<tr><td colspan="3" class="px-4 py-2 text-gray-500 text-center">Nema clanova tima</td></tr>';
                }
                $('#teamList tbody').html(teamContent);
                $('#teamSection').show();
            }
        }
